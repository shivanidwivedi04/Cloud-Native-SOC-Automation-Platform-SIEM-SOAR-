import requests
from requests.auth import HTTPBasicAuth
import os
from datetime import datetime, timezone, timedelta

ES = "http://192.168.10.102:9200"
USER = "elastic"
PASS = "Eu950PG2NZ359e*eHlAe"

RULE_NAME = "SSH Brute Force Detection"
TIME_WINDOW = 15  # minutes

# Load whitelist
with open("whitelist.txt") as f:
    WHITELIST = [line.strip() for line in f.readlines()]

query = {
  "query": {
    "bool": {
      "must": [
        {"wildcard": {"kibana.alert.rule.name": "*SSH*"}},
        {"range": {
          "@timestamp": {
            "gte": "now-15m"
          }
        }}
      ]
    }
  },
  "sort": [{"@timestamp": "desc"}],
  "size": 1
}

r = requests.post(
    f"{ES}/.alerts-security.alerts-*/_search",
    json=query,
    auth=HTTPBasicAuth(USER, PASS)
)

if r.status_code != 200:
    print("‚ùå Elasticsearch query failed")
    exit()

hits = r.json()["hits"]["hits"]

if not hits:
    print("‚ÑπÔ∏è No recent alerts ‚Äî no action taken")
    exit()

alert = hits[0]["_source"]

attacker_ip = (
    alert.get("kibana", {})
         .get("alert", {})
         .get("source", {})
         .get("ip")
)

if not attacker_ip:
    print("‚ö†Ô∏è Attacker IP not found in alert")
    exit()

if attacker_ip in WHITELIST:
    print(f"‚úÖ {attacker_ip} is whitelisted ‚Äî skipping block")
    exit()

print(f"üö® Recent attack detected from {attacker_ip}")
os.system(
    f"ansible-playbook -i hosts block_ip.yml --extra-vars 'ip={attacker_ip}'"
)
